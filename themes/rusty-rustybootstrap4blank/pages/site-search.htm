title = "Search Content"
url = "/site-search"
layout = "default"
is_hidden = 0
==
<?php
use Corymillz\Adverts\Models\Advert;
use RainLab\User\Models\User;
use Corymillz\Adverts\Models\Rating;
use Corymillz\Adverts\Models\Msb;
use Corymillz\Adverts\Models\Mbb;
use Corymillz\Adverts\Models\Meb;
use Corymillz\Adverts\Models\Bmsb;
use Corymillz\Adverts\Models\Bmbb;
use Corymillz\Adverts\Models\Bmeb;
use Carbon\Carbon;

public function onStart(){

$this['url'] = Request::url();

Session::put('search', Input::get('q'));
if (Session::has('search')) {
$this['query'] = Session::get('search');
}

	$search = Input::get('q'); 
	

	$this['ads']  = Advert::withCount(['ratings as rating' => function ($query) {
    $query->select(DB::raw('COALESCE(avg(rating), 0)'));
}])->where('title', 'LIKE', '%' . $search . '%')->orderBy('created_at','desc')->paginate(10)->appends(['q' => $search]);





$msbId = Msb::lists('msb');

Msb::where('created_at', '<', now()->subDays(30))->delete();  
$this['msBoost'] = Advert::whereIn('id', $msbId)->pluck('id'); 

    

$mbbId = Mbb::lists('mbb');

Mbb::where('created_at', '<', now()->subDays(30))->delete();  
$this['mbBoost'] = Advert::whereIn('id', $mbbId)->pluck('id'); 



$mebId = Meb::lists('meb');

Meb::where('created_at', '<', now()->subDays(30))->delete();  
$this['meBoost'] = Advert::whereIn('id', $mebId)->pluck('id'); 



$bmsbId = Bmsb::lists('bmsb');

Bmsb::where('created_at', '<', now()->subDays(15))->delete();  
$this['bmsBoost'] = Advert::whereIn('id', $bmsbId)->pluck('id'); 

$bmbbId = Bmbb::lists('bmbb');

Bmbb::where('created_at', '<', now()->subDays(15))->delete();  
$this['bmbBoost'] = Advert::whereIn('id', $bmbbId)->pluck('id');

$bmebId = Bmeb::lists('bmeb');

Bmeb::where('created_at', '<', now()->subDays(15))->delete();  
$this['bmeBoost'] = Advert::whereIn('id', $bmebId)->pluck('id');

}




function onBookmark()
{
 
$recordId = post('bookmark');

$record = Advert::find($recordId);

$user=  Auth::getUser();

$user->ads()->syncWithoutDetaching($record);
Flash::success('Successfully Added!');




}




?>
==





 <div class="container d-xl-none" style="margin-top: -30px;  font-family: arial;">
  <div class="starter-template" style="margin: -35px ">
<p>
  <a class="btn btn-primary shadow" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">  
    <span class="fa fa-filter"></span> Filter by Location
  </a>
<div class="collapse" id="collapseExample">
  <div class="card card-body">
    <form class=" my-1 col-12 col-lg-8" action="{{ 'site-search-location'|page }}" method="POST">
            <small><b><label class="float-left">Filter by Location</label></b></small><br>
 <div  class="form-group">
<select style="width: 100%" id="search" class="form-control form-control-sm form-select search" name='location' multiple="multiple">
  
</select>
</div>

<button  class="btn btn-outline-info col-6 rounded-pill" type="submit">Apply Filter</button>
</form>

</div></div>

{% if query %}
<div align="center"><h6 style="color: grey; margin-top: 10px">Search results for "{{ query }}"</h6></div>
{% endif %}
<br><br>





<div id="site-search" class="main-section">
  
  {% partial 'product-list' %}
</div>








</div>
</div>






<!-- 
desktop view
-->
<span class="float-left d-none d-xl-block" style="width: 25%; margin-left: 20px; margin-top: -20px">
  <br><br><br><br><br>
    <div class="card card-body shadow-sm" >
    <form class=" my-1 col-12 col-lg-8" action="{{ 'site-search-location'|page }}" method="POST">
            <small><b><label class="float-left">Filter by Location</label></b></small><br>
 <div  class="form-group">
<select style="width: 170%" id="searchdesktop" class="form-control form-control-sm form-select searchCity" name='location' multiple="multiple">
  
</select>


</div>

<button  class="btn btn-sm btn-info" type="submit">Apply Filter</button>
</form>

</div>
<br>
  <div class="card card-body shadow-sm" style="background-color: lightgrey">
    <h5>Post One Buy Request, Get Multiple Offers</h5><hr style="color: #1484B3">
        <div class="container">
   <div class="row" align="center">

  <div class="col" >
  <img style="height: 70px; width: auto" src="{{ 'assets/images/write-icon.png'|theme }}">
  <p align="center" style="color: grey; font-family: arial; font-size: 14px">Write a Buy Request</p>
  </div>


    <div class="col">
   <img style="height: 70px; width: auto" src="{{ 'assets/images/contact-icon.png'|theme }}">
    <p align="center" style="color: grey; font-family: arial; font-size: 14px">Get Contacted by Suppliers</p>
    </div>

    <div class="col" style="margin-top: -30px;">
   <img style="height: 120px; width: 120px;" src="{{ 'assets/images/handi.png'|theme }}">
    <p align="center" style="color: grey; font-family: arial; font-size: 14px; margin-top: -20px">Close a Favourable Deal</p>
  </div>
  
  </div>
</div>
<a href="{{ 'request'|page }}"><div align="center"><button style="background-color: #08172A; color: white;" type="button" class="btn btn-sm" >Post a Buy Request</button></div></a>
  </div><br>
</span>

<div class="container d-none d-xl-block"  style="margin-top: -50px;  font-family: arial;">
  <div class="starter-template" style="margin-right: -150px;  margin-left: 40px"><br>
{% if query %}
<div align="center"><h6 style="color: grey; margin-top: 10px">Search results for "{{ query }}"</h6></div>
{% endif %}
<hr><br>
   
<div id="product-list" class="main-section" id="main-section">
  <div  align="left" style="margin-left: 10px"><small>All Nigeria</small></div> <br><br> 
  
  {% partial "product/product-list-desktop" %}

</div>

</div>
</div>



<!--
end of desktop view
-->



















<div class="modal fade" id="bookmarkModal" tabindex="-1" role="dialog" aria-labelledby="bookmarkModal" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered " role="document">
    <div class="modal-content">
      
        
      <div class="modal-body">

        <p align="center" style="font-size: 20px; font-family: arial; color: grey; font-family: arial">
           <div align="center" style="font-size: 20px" class="result">
            
          </div>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancel-button">Cancel</button>
        <button type="button" class="btn btn-primary" id="okay-button">Ok</button>
      </div>
    </div>
  </div>
</div>

{% put scripts %}
<script>
    $(window).on('ajaxConfirmMessage', function(event, message) {
        // Stop the default confirm dialog
        event.preventDefault();    

        // open our own bootstrap modal
        $('#bookmarkModal').modal('show'); 
         $(".result").html(message);
        // Okay Button. we will unbind if any events are attached to it first
        // reattach click event - this is required as this code will call each time
        $('#okay-button').unbind().click(function() {        
            // hide modal
            $('#bookmarkModal').modal('hide'); 
            // Resolve the deferred object, this will trigger whatever was being confirmed
            event.promise.resolve();
        });

        // Cancel Button
        $('#cancel-button').unbind().click(function() {        
            // hide modal
            $('#bookmarkModal').modal('hide'); 
            // Reject the object, this will cancel whatever was being confirmed            
            event.promise.reject();        
        });

        // Return a value so the framework knows we're handling the confirm
        return true;
    });
</script>



<script type="text/javascript">
   let search_dropdown_desktop = $("#searchdesktop");

search_dropdown_desktop.empty();


search_dropdown_desktop.prop('selectedIndex', 0);

const url_desktop = '/location.json';

// Populate search_dropdown_desktop with list of provinces
$.getJSON(url_desktop, function (data) {
  $.each(data, function (key, entry) {
    search_dropdown_desktop.append($('<option></option>').attr('value',  entry.city).text(entry.city));
  })
});

</script>



{% endput %}








